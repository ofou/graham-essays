name: "Build and Release"
permissions:
  contents: write # Needed for creating releases
on:
  push:
    branches: [main]
    paths:
      - 'essays/**'
      - 'Makefile'
      - 'metadata.yaml'
      - 'requirements.txt'
      - 'cover.png'
  pull_request:
    branches: [main]
    paths:
      - 'essays/**'
      - 'Makefile'
      - 'metadata.yaml'
      - 'requirements.txt'
      - 'cover.png'
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      num_articles: ${{ steps.count_articles.outputs.num_articles }}
      should_release: ${{ steps.check_release_needed.outputs.should_release }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives/*.deb
            /var/lib/apt/lists/*
          key: apt-packages-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            apt-packages-${{ runner.os }}-

      - name: Cache Python packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Build
        run: |
          make all

      - name: Validate build outputs
        run: |
          echo "Validating build outputs..."
          if [ ! -f "graham.epub" ]; then
            echo "‚ùå Error: graham.epub not found"
            exit 1
          fi
          if [ ! -f "essays.csv" ]; then
            echo "‚ùå Error: essays.csv not found"
            exit 1
          fi
          if [ ! -f "graham.md" ]; then
            echo "‚ùå Error: graham.md not found"
            exit 1
          fi
          echo "‚úÖ All required build outputs found"

      - name: Stage artifacts
        run: |
          mkdir -p dist
          echo "Staging build artifacts..."

          # Check and move EPUB file
          if [ -f "graham.epub" ]; then
            mv graham.epub dist/
            echo "‚úÖ Moved graham.epub to dist/"
          else
            echo "‚ùå Error: graham.epub not found to stage"
            exit 1
          fi

          # Check and copy CSV file
          if [ -f "essays.csv" ]; then
            cp essays.csv dist/
            echo "‚úÖ Copied essays.csv to dist/"
          else
            echo "‚ùå Error: essays.csv not found"
            exit 1
          fi

      - name: Count number of articles
        id: count_articles
        run: |
          if [ -f "essays.csv" ]; then
            NUM_ARTICLES=$(( $(wc -l < essays.csv) - 1 ))
            NUM_ARTICLES=$(( NUM_ARTICLES < 0 ? 0 : NUM_ARTICLES ))
            echo "num_articles=$NUM_ARTICLES" >> $GITHUB_OUTPUT
          else
            echo "num_articles=0" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Check if release is needed
        id: check_release_needed
        run: |
          # Function to fetch latest release with retry logic
          fetch_latest_release() {
            for i in {1..3}; do
              echo "Attempt $i: Fetching latest release info..."
              local response=$(curl -s --max-time 30 -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
              if [ $? -eq 0 ] && [ "$response" != "null" ] && echo "$response" | jq -e '.tag_name' >/dev/null 2>&1; then
                echo "$response" | jq -r '.tag_name'
                return 0
              else
                echo "Attempt $i failed"
                if [ $i -lt 3 ]; then
                  echo "Retrying in 2 seconds..."
                  sleep 2
                fi
              fi
            done
            echo ""
            return 1
          }

          # Get latest release tag
          LATEST_TAG=$(fetch_latest_release)
          if [ -n "$LATEST_TAG" ]; then
            echo "Successfully retrieved latest release: $LATEST_TAG"
          else
            echo "Failed to retrieve latest release after retries"
            LATEST_TAG=""
          fi

          # Extract number of essays from the tag (expected format: YYYY-MM-DD_NNN)
          if [[ $LATEST_TAG =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}_([0-9]+)$ ]]; then
            LAST_ARTICLE_COUNT=${BASH_REMATCH[1]}
            echo "‚úÖ Valid tag format found: $LATEST_TAG -> $LAST_ARTICLE_COUNT articles"
          else
            echo "‚ö†Ô∏è  Unexpected tag format: '$LATEST_TAG' (expected YYYY-MM-DD_NNN)"
            # If there's no previous release or the format is different, default to 0
            LAST_ARTICLE_COUNT=0
            echo "Defaulting to 0 articles for release comparison"
          fi

          echo "Latest release article count: $LAST_ARTICLE_COUNT"
          echo "Current article count: ${{ steps.count_articles.outputs.num_articles }}"

          # Release if article count increased
          if [ "${{ steps.count_articles.outputs.num_articles }}" -gt "$LAST_ARTICLE_COUNT" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "New articles detected. A release will be created."
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "No new articles detected. No release needed."
          fi

      - name: Validate artifacts for upload
        run: |
          echo "Validating artifacts before upload..."
          if [ ! -d "dist" ]; then
            echo "‚ùå Error: dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/essays.csv" ]; then
            echo "‚ùå Error: essays.csv not found in dist/"
            exit 1
          fi
          echo "‚úÖ Artifacts validated for upload"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 30
          if-no-files-found: error
  
  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download previous essays.csv
        run: |
          # Function to fetch latest release with retry logic
          fetch_latest_release() {
            for i in {1..3}; do
              echo "Attempt $i: Fetching latest release info..."
              local response=$(curl -s --max-time 30 -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest")
              if [ $? -eq 0 ] && [ "$response" != "null" ]; then
                local tag=$(echo "$response" | jq -r '.tag_name')
                if [ "$tag" != "null" ] && [ -n "$tag" ]; then
                  echo "$tag"
                  return 0
                fi
              fi
              echo "Attempt $i failed"
              if [ $i -lt 3 ]; then
                echo "Retrying in 2 seconds..."
                sleep 2
              fi
            done
            return 1
          }

          # Function to download file with retry logic
          download_with_retry() {
            local url="$1"
            local output="$2"
            for i in {1..3}; do
              if curl -s -L --max-time 30 -o "$output" "$url"; then
                echo "Successfully downloaded $output"
                return 0
              else
                echo "Download attempt $i failed for $output"
                if [ $i -lt 3 ]; then
                  echo "Retrying in 2 seconds..."
                  sleep 2
                fi
              fi
            done
            return 1
          }

          # Get the latest release
          LATEST_TAG=$(fetch_latest_release)

          if [ -n "$LATEST_TAG" ]; then
            echo "Downloading essays.csv from release $LATEST_TAG"
            download_with_retry "https://github.com/${{ github.repository }}/releases/download/$LATEST_TAG/essays.csv" "previous_essays.csv"
            # Verify download succeeded
            if [ ! -f "previous_essays.csv" ]; then
              echo "Failed to download previous essays.csv, creating empty placeholder"
              echo "Article no.,Title,Date,URL" > previous_essays.csv
            fi
          else
            echo "No previous release found, creating empty placeholder"
            echo "Article no.,Title,Date,URL" > previous_essays.csv
          fi

      - name: Generate release notes
        id: generate_release_notes
        working-directory: dist
        run: |
          python3 -c "
          import csv
          import sys
          import os

          def get_last_article_num(csv_file):
              if not os.path.exists(csv_file):
                  return 0
              max_num = 0
              with open(csv_file, 'r', encoding='utf-8') as f:
                  reader = csv.reader(f)
                  next(reader, None)  # Skip header
                  for row in reader:
                      if row and row[0].strip():
                          try:
                              num = int(row[0].strip('\"'))
                              max_num = max(max_num, num)
                          except (ValueError, IndexError):
                              continue
              return max_num

          def format_new_articles(current_csv, last_num):
              new_articles = []
              with open(current_csv, 'r', encoding='utf-8') as f:
                  reader = csv.reader(f)
                  next(reader, None)  # Skip header
                  for row in reader:
                      if len(row) >= 4:
                          try:
                              article_num = int(row[0].strip('\"'))
                              if article_num > last_num:
                                  title = row[1].strip('\"')
                                  date = row[2].strip('\"')
                                  url = row[3].strip('\"')
                                  new_articles.append(f'- [**{title}**]({url}) ({date})')
                          except (ValueError, IndexError):
                              continue
              return new_articles

          # Main logic
          if os.path.exists('essays.csv') and os.path.exists('../previous_essays.csv'):
              last_article_num = get_last_article_num('../previous_essays.csv')
              print(f'Last article number from previous release: {last_article_num}', file=sys.stderr)
              print(f'Current total articles: ${{ needs.build.outputs.num_articles }}', file=sys.stderr)

              new_articles = format_new_articles('essays.csv', last_article_num)

              if new_articles:
                  release_notes = f'## üìö New Essays Added\n\n' + '\n'.join(new_articles) + f'\n\n---\n\n**Total essays in collection:** ${{ needs.build.outputs.num_articles }}'
              else:
                  release_notes = f'## üìö Collection Updated\n\nNo new essays detected in this update.\n\n**Total essays in collection:** ${{ needs.build.outputs.num_articles }}'
          else:
              release_notes = f'## üìö New Collection Release\n\n**Total essays in collection:** ${{ needs.build.outputs.num_articles }}'

          # Write outputs using file-based approach (GitHub recommends this over deprecated ::set-output)
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'release_notes<<EOF\n{release_notes}\nEOF\n')
              f.write(f'new_articles_count={len(new_articles) if \"new_articles\" in locals() else 0}\n')
          "

      - name: Generate version string
        id: generate_version
        working-directory: dist
        run: |
          DATE=$(date +%Y-%m-%d)
          VERSION="${DATE}_${{ needs.build.outputs.num_articles }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "RELEASE_TITLE=$DATE, ${{ needs.build.outputs.num_articles }} essays" >> $GITHUB_ENV
      
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          tag_name: "${{ env.VERSION }}"
          name: "${{ env.RELEASE_TITLE }}"
          body: "${{ steps.generate_release_notes.outputs.release_notes }}"
          prerelease: false
          files: |
            dist/*.epub
            dist/essays.csv
